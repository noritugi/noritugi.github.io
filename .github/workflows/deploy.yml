name: Build, Toot and Deploy (with post URL and safe front-matter write)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # allow git push with GITHUB_TOKEN later
          persist-credentials: true

      # ---------- detect changed markdown (first changed .md in commit) ----------
      - name: Detect changed markdown
        id: detect_md
        run: |
          FILE=$(git diff --name-only HEAD~1 HEAD | grep '\.md$' | head -n 1 || true)
          echo "file=${FILE}" >> $GITHUB_OUTPUT

      - name: Abort if no markdown changed
        if: ${{ steps.detect_md.outputs.file == '' }}
        run: |
          echo "No markdown changed in the last commit. Exiting."
          exit 0

      # ---------- extract front-matter metadata (title, slug, date) ----------
      - name: Extract metadata from front matter
        id: meta
        run: |
          FILE="${{ steps.detect_md.outputs.file }}"
          # slug := filename without extension
          SLUG="$(basename "$FILE" .md)"
          # try to get date and title from YAML front matter
          DATE=$(awk '/^---/{flag++; next} flag==1 && /^date:/{print substr($0, index($0,$2)); exit}' "$FILE" || echo "")
          TITLE=$(awk '/^---/{flag++; next} flag==1 && /^title:/{sub(/^title:[[:space:]]*/,""); print; exit}' "$FILE" || echo "")
          # fallback values
          if [ -z "$DATE" ]; then DATE=$(date -u +%Y-%m-%d); fi
          if [ -z "$TITLE" ]; then TITLE="$SLUG"; fi
          YEAR=$(echo "$DATE" | cut -c1-4)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT

      # ---------- compute public post URL using BLOG_URL and year/slug ----------
      - name: Make public post URL
        id: url
        run: |
          SITE_URL="${{ secrets.BLOG_URL }}"
          SLUG="${{ steps.meta.outputs.slug }}"
          YEAR="${{ steps.meta.outputs.year }}"
          # ensure no trailing slash on SITE_URL
          SITE_URL="${SITE_URL%/}"
          POST_URL="$SITE_URL/posts/$YEAR/$SLUG/"
          echo "post_url=$POST_URL" >> $GITHUB_OUTPUT
          echo "Computed post url: $POST_URL"

      # ---------- check [no-toot] in commit message ----------
      - name: Check [no-toot]
        id: detect_no_toot
        run: |
          if git log -1 --pretty=%B | grep -qi "\[no-toot\]"; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      # ---------- optional direct test (uncomment for debug) ----------
      # - name: Safe Test Toot (direct) 
      #   if: steps.detect_no_toot.outputs.skip == 'false'
      #   run: |
      #     curl -v -X POST \
      #       -H "Authorization: Bearer ${{ secrets.MASTODON_ACCESS_TOKEN }}" \
      #       -F "status=Check connectivity to Mastodon from Actions" \
      #       "${{ secrets.MASTODON_URL }}/api/v1/statuses"

      # ---------- send toot (action) ----------
      - name: Send toot to Mastodon
        id: mastodon
        if: steps.detect_no_toot.outputs.skip == 'false'
        uses: cbrgm/mastodon-github-action@v2
        with:
          access-token: ${{ secrets.MASTODON_ACCESS_TOKEN }}
          url: ${{ secrets.MASTODON_URL }}
          # message includes title and post URL
          message: |
            ðŸ“–æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼

            ã‚¿ã‚¤ãƒˆãƒ«: ${{ steps.meta.outputs.title }}
            URL: ${{ steps.url.outputs.post_url }}

            ðŸ“­ã‚³ãƒ¡ãƒ³ãƒˆã¯ã“ã®ãƒˆã‚¥ãƒ¼ãƒˆã«è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚

      # ---------- record toot URL ----------
      - name: Get toot URL
        id: tooturl
        if: steps.detect_no_toot.outputs.skip == 'false'
        run: |
          # the cbrgm action sets outputs.url â€” expose to GITHUB_OUTPUT
          echo "url=${{ steps.mastodon.outputs.url }}" >> $GITHUB_OUTPUT
          echo "toot_url=${{ steps.mastodon.outputs.url }}"

      # ---------- install python yaml tool ----------
      - name: Install PyYAML
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml

      # ---------- update front matter safely with Python (add/replace comments.src) ----------
      - name: Write comment URL into front matter (safe YAML)
        id: write_front
        if: steps.detect_no_toot.outputs.skip == 'false'
        run: |
          FILE="${{ steps.detect_md.outputs.file }}"
          TOOT_URL="${{ steps.tooturl.outputs.url }}"
          echo "Updating front-matter in $FILE with comments.src = $TOOT_URL"
          python3 - <<'PY'
import sys, yaml, io, os, re
file_path = os.environ['FILE']
toot = os.environ['TOOT_URL']

# read entire file
with open(file_path, 'r', encoding='utf-8') as f:
    txt = f.read()

# match YAML front matter
m = re.match(r'^---\n(.*?)\n---\n(.*)$', txt, re.S)
if not m:
    print("No YAML front matter found; will prepend one.")
    fm = {}
    body = txt
else:
    fm_text = m.group(1)
    body = m.group(2)
    # parse YAML front matter
    fm = yaml.safe_load(fm_text) or {}

# ensure comments mapping exists and set src
if not isinstance(fm, dict):
    fm = {}
comments = fm.get('comments')
if not isinstance(comments, dict):
    comments = {}
comments['src'] = toot
fm['comments'] = comments

# dump YAML with same style (block)
new_fm = yaml.safe_dump(fm, allow_unicode=True, sort_keys=False).strip()

with open(file_path, 'w', encoding='utf-8') as f:
    f.write('---\n')
    f.write(new_fm)
    f.write('\n---\n')
    f.write(body)

print("Front matter updated.")
PY
        env:
          FILE: ${{ steps.detect_md.outputs.file }}
          TOOT_URL: ${{ steps.tooturl.outputs.url }}

      # ---------- commit and push updated front matter ----------
      - name: Commit updated front matter
        if: steps.detect_no_toot.outputs.skip == 'false'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add "${{ steps.detect_md.outputs.file }}"
          # commit only if changes present
          if ! git diff --staged --quiet; then
            git commit -m "ci: add Mastodon comment URL for ${{ steps.meta.outputs.slug }}"
            git push origin HEAD:main
          else
            echo "No changes to commit."

      # ---------- Setup Deno for Lume build ----------
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v1.x

      - name: Build site (Lume)
        run: deno task build

      # ---------- Deploy to Netlify ----------
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './_site'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: false
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
